!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self)[""]=e[""]||{},e[""]["/dist/mapbox-gl-ogc-feature-collection"]=e[""]["/dist/mapbox-gl-ogc-feature-collection"]||{},e[""]["/dist/mapbox-gl-ogc-feature-collection"].min=e[""]["/dist/mapbox-gl-ogc-feature-collection"].min||{},e[""]["/dist/mapbox-gl-ogc-feature-collection"].min.js=t())}(this,(function(){"use strict";var e=Math.PI/180,t=180/Math.PI;function i(e){var t=o(e[0]+1,e[2]);return[o(e[0],e[2]),n(e[1]+1,e[2]),t,n(e[1],e[2])]}function o(e,t){return e/Math.pow(2,t)*360-180}function n(e,i){var o=Math.PI-2*Math.PI*e/Math.pow(2,i);return t*Math.atan(.5*(Math.exp(o)-Math.exp(-o)))}function s(e,t,i){var o=h(e,t,i);return o[0]=Math.floor(o[0]),o[1]=Math.floor(o[1]),o}function r(e){return[[2*e[0],2*e[1],e[2]+1],[2*e[0]+1,2*e[1],e[2]+1],[2*e[0]+1,2*e[1]+1,e[2]+1],[2*e[0],2*e[1]+1,e[2]+1]]}function a(e){return[e[0]>>1,e[1]>>1,e[2]-1]}function l(e){return r(a(e))}function c(e,t){for(var i=0;i<e.length;i++)if(u(e[i],t))return!0;return!1}function u(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function h(t,i,o){var n=Math.sin(i*e),s=Math.pow(2,o),r=s*(t/360+.5);return(r%=s)<0&&(r+=s),[r,s*(.5-.25*Math.log((1+n)/(1-n))/Math.PI),o]}var f={tileToGeoJSON:function(e){var t=i(e);return{type:"Polygon",coordinates:[[[t[0],t[3]],[t[0],t[1]],[t[2],t[1]],[t[2],t[3]],[t[0],t[3]]]]}},tileToBBOX:i,getChildren:r,getParent:a,getSiblings:l,hasTile:c,hasSiblings:function(e,t){for(var i=l(e),o=0;o<i.length;o++)if(!c(t,i[o]))return!1;return!0},tilesEqual:u,tileToQuadkey:function(e){for(var t="",i=e[2];i>0;i--){var o=0,n=1<<i-1;e[0]&n&&o++,e[1]&n&&(o+=2),t+=o.toString()}return t},quadkeyToTile:function(e){for(var t=0,i=0,o=e.length,n=o;n>0;n--){var s=1<<n-1,r=+e[o-n];1===r&&(t|=s),2===r&&(i|=s),3===r&&(t|=s,i|=s)}return[t,i,o]},pointToTile:s,bboxToTile:function(e){var t=s(e[0],e[1],32),i=s(e[2],e[3],32),o=[t[0],t[1],i[0],i[1]],n=function(e){for(var t=28,i=0;i<t;i++){var o=1<<32-(i+1);if((e[0]&o)!=(e[2]&o)||(e[1]&o)!=(e[3]&o))return i}return t}(o);return 0===n?[0,0,0]:[o[0]>>>32-n,o[1]>>>32-n,n]},pointToTileFraction:h};return class{constructor(e,t,i,o){if(!e||!t||!i)throw new Error("Source id, map and collectionOptions must be supplied as the first three arguments.");if(!i.url)throw new Error("A url must be supplied as part of the collectionOptions object.");if(!i.collectionId)throw new Error("A collectionId must be supplied as part of the collectionOptions object.");this.sourceId=e,this._map=t,this._tileIndices=new Map,this._featureIndices=new Map,this._featureCollections=new Map,this._collectionServiceOptions=Object.assign({limit:5e3,useStaticZoomLevel:!1,minZoom:i.useStaticZoomLevel?7:2},i),this.serviceMetadata=null,this._maxExtent=[-1/0,1/0,-1/0,1/0];const n=o||{};this._map.addSource(e,Object.assign(n,{type:"geojson",data:this._getBlankFc()})),this.enableRequests(),this._clearAndRefreshTiles()}destroySource(){this.disableRequests(),this._map.removeSource(this.sourceId)}_getBlankFc(){return{type:"FeatureCollection",features:[]}}disableRequests(){this._map.off("moveend",this._boundEvent)}enableRequests(){this._boundEvent=this._findAndMapData.bind(this),this._map.on("moveend",this._boundEvent)}_clearAndRefreshTiles(){this._tileIndices=new Map,this._featureIndices=new Map,this._featureCollections=new Map,this._findAndMapData()}_createOrGetTileIndex(e){const t=this._tileIndices.get(e);if(t)return t;const i=new Map;return this._tileIndices.set(e,i),i}_createOrGetFeatureCollection(e){const t=this._featureCollections.get(e);if(t)return t;const i=this._getBlankFc();return this._featureCollections.set(e,i),i}_createOrGetFeatureIdIndex(e){const t=this._featureIndices.get(e);if(t)return t;const i=new Map;return this._featureIndices.set(e,i),i}async _findAndMapData(){const e=this._map.getZoom();if(e<this._collectionServiceOptions.minZoom)return;const t=this._map.getBounds().toArray(),i=f.bboxToTile([t[0][0],t[0][1],t[1][0],t[1][1]]),o=this._collectionServiceOptions.useStaticZoomLevel?this._collectionServiceOptions.minZoom:2*Math.floor(e/2),n=this._createOrGetTileIndex(o),s=this._createOrGetFeatureIdIndex(o),r=this._createOrGetFeatureCollection(o),a=[];if(i[2]<o){let e=f.getChildren(i),n=e[0][2];for(;n<o;){const t=[];e.forEach((e=>t.push(...f.getChildren(e)))),e=t,n=e[0][2]}for(let i=0;i<e.length;i++)this._doesTileOverlapBbox(e[i],t)&&a.push(e[i])}else a.push(i);for(let e=0;e<a.length;e++){const t=f.tileToQuadkey(a[e]);n.has(t)?(a.splice(e,1),e--):n.set(t,!0)}if(0===a.length)return void this._updateFcOnMap(r);const l=Math.abs(t[1][0]-t[0][0])/this._map.getCanvas().width*this._collectionServiceOptions.simplifyFactor;await this._loadTiles(a,l,s,r),this._updateFcOnMap(r)}async _loadTiles(e,t,i,o){return new Promise((n=>{const s=e.map((e=>this._getTile(e,t)));Promise.all(s).then((e=>{e.forEach((e=>{e&&this._iterateItems(e,i,o)})),n()}))}))}_iterateItems(e,t,i){null!=e.features&&e.features.forEach((e=>{t.has(e.id)||(i.features.push(e),t.set(e.id))}))}_getTile(e){const t=f.tileToBBOX(e);let i=`limit=${this._collectionServiceOptions.limit}&bbox=${t[0]},${t[1]},${t[2]},${t[3]}`,o=["limit","url","useStaticZoomLevel","collectionId","minZoom"];for(let e in this._collectionServiceOptions)o.includes(e)||(i+=`&${e}=${this._collectionServiceOptions[e]}`);return new Promise((e=>{fetch(`${this._collectionServiceOptions.url}/collections/${this._collectionServiceOptions.collectionId}/items?${i}`,this._collectionServiceOptions.fetchOptions).then((e=>e.json())).then((t=>{e(t)}))}))}_updateFcOnMap(e){this._map.getSource(this.sourceId).setData(e)}_doesTileOverlapBbox(e,t){const i=4===e.length?e:f.tileToBBOX(e);return!(i[2]<t[0][0])&&(!(i[0]>t[1][0])&&(!(i[3]<t[0][1])&&!(i[1]>t[1][1])))}}}));
